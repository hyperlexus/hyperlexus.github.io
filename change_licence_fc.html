<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>RKP License Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako_inflate.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f0ff; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .btn-primary { background-color: #7B68EE; transition: all 0.2s; }
        .btn-primary:hover { background-color: #6A5ACD; transform: translateY(-1px); }
    </style>
</head>
<body class="min-h-screen py-10 px-4">
<div class="max-w-2xl mx-auto space-y-8">

    <div class="text-center">
        <h1 class="text-4xl font-bold text-indigo-900 tracking-tight">change-licence-fc</h1>
        <p class="text-indigo-500 mt-2 font-medium">Web Edition</p>
    </div>

    <div class="glass p-8 rounded-3xl shadow-xl border border-white">
        <h2 class="text-xl font-semibold text-indigo-800 mb-4 flex items-center">
            <span class="mr-2"></span> Converter
        </h2>
        <div class="flex flex-col sm:flex-row gap-2">
            <input id="convInput" type="text" placeholder="Enter FC or PID" class="flex-1 p-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-400 outline-none">
            <button onclick="handleConvert()" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold shadow-md">Convert</button>
        </div>
        <p id="convResult" class="mt-4 text-center font-mono text-lg text-indigo-900 font-bold"></p>
    </div>

    <div class="glass p-8 rounded-3xl shadow-xl border border-white">
        <h2 class="text-xl font-semibold text-indigo-800 mb-4 flex items-center">
            <span class="mr-2"></span> Write New FC to RKP
        </h2>
        <div class="space-y-4">
            <input id="rkpIdInput" type="text" placeholder="Target FC or PID" class="w-full p-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-400 outline-none">

            <div class="relative group">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-indigo-200 border-dashed rounded-xl cursor-pointer bg-white/30 group-hover:bg-indigo-50/50 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <p id="fileName" class="text-sm text-indigo-600 font-medium">Select or Drop .rkp file</p>
                    </div>
                    <input id="rkpFile" type="file" class="hidden" accept=".rkp" onchange="updateFileName()"/>
                </label>
            </div>

            <button onclick="handleRkpProcess()" class="w-full btn-primary text-white py-4 rounded-xl font-bold shadow-lg uppercase tracking-wider">Patch & Download</button>
            <p id="rkpStatus" class="text-sm text-center font-medium"></p>
        </div>
    </div>

    <div class="glass p-8 rounded-3xl shadow-xl border border-white">
        <h2 class="text-xl font-semibold text-indigo-800 mb-4 flex items-center">
            <span class="mr-2"></span> pinfo query
        </h2>
        <div class="flex flex-col sm:flex-row gap-2">
            <input id="pinfoInput" type="text" placeholder="Enter FC or PID" class="flex-1 p-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-400 outline-none">
            <button onclick="handlePinfo()" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold shadow-md">Check</button>
        </div>
        <div id="pinfoResult" class="mt-4 p-4 rounded-xl bg-white/50 border border-indigo-50 hidden text-indigo-900"></div>
    </div>
</div>

<script>
    function pidToFc(pid) {
        if (!pid || pid === 0) return "0";

        // pid -> little endian
        const buffer = new ArrayBuffer(8);
        const view = new DataView(buffer);
        view.setUint32(0, pid, true);

        // 'jmcr' salt
        const jcmr = [74, 67, 77, 82];
        const uint8 = new Uint8Array(buffer);
        for(let i = 0; i < 4; i++) {
            uint8[4 + i] = jcmr[i];
        }

        // sparkmd5 hash (pretty sure this works)
        const spark = new SparkMD5.ArrayBuffer();
        spark.append(buffer);
        const hexHash = spark.end();

        // get first byte
        const firstByte = parseInt(hexHash.substring(0, 2), 16);

        // get high bit
        const high = BigInt(firstByte >> 1);

        // original binary or
        const fcBigInt = (high << 32n) | BigInt(pid);
        return fcBigInt.toString();
    }

    function fcToPid(fc) {
        const cleaned = fc.replace(/-/g, "");
        return Number(BigInt(cleaned) & 0xFFFFFFFFn);
    }

    function formatFc(fcStr) {
        const padded = fcStr.padStart(12, '0');
        return `${padded.slice(0, 4)}-${padded.slice(4, 8)}-${padded.slice(8)}`;
    }

    function crc32(buffer) {
        // using bitwise logic (this took an hour)
        let table = new Uint32Array(256);
        for (let i = 0; i < 256; i++) {
            let c = i;
            for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
            table[i] = c;
        }
        let crc = 0xFFFFFFFF;
        for (let i = 0; i < buffer.length; i++) {
            crc = (crc >>> 8) ^ table[(crc ^ buffer[i]) & 0xFF];
        }
        return (crc ^ 0xFFFFFFFF) >>> 0;
    }

    function updateFileName() {
        const file = document.getElementById('rkpFile').files[0];
        if (file) document.getElementById('fileName').innerText = file.name;
    }

    function handleConvert() {
        const val = document.getElementById('convInput').value.trim();
        const resEl = document.getElementById('convResult');

        if (!val) return;

        if (val.includes("-")) {
            // fc to pid
            resEl.innerText = `PID: ${fcToPid(val)}`;
        } else {
            // pid to fc
            const pid = parseInt(val);
            if (isNaN(pid)) {
                resEl.innerText = "Invalid input";
                return;
            }
            const fcRaw = pidToFc(pid);
            resEl.innerText = `FC: ${formatFc(fcRaw)}`;
        }
    }

    async function handlePinfo() {
        const input = document.getElementById('pinfoInput').value.trim();
        const pid = input.includes("-") ? fcToPid(input) : parseInt(input);
        const box = document.getElementById('pinfoResult');

        box.classList.remove('hidden');
        box.innerHTML = "Checking...";

        try {
            const response = await fetch("https://api.hyperlexus.uk/api/pinfo", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pid })
            });
            const data = await response.json();
            if (data.User) {
                box.innerHTML = `<strong>Taken by:</strong> ${data.User.LastInGameSn}<br>
                                    <strong>Banned:</strong> ${data.User.Restricted ? 'ðŸ”´ Yes' : 'ðŸŸ¢ No'}`;
            } else {
                box.innerHTML = `<span class="text-green-600 font-bold">âœ… This FC is free!</span>`;
            }
        } catch (e) {
            box.innerHTML = `<span class="text-red-500">${e}</span>`;
        }
    }

    async function handleRkpProcess() {
        const fileInput = document.getElementById('rkpFile');
        const idInput = document.getElementById('rkpIdInput').value.trim();
        const status = document.getElementById('rkpStatus');

        if (!fileInput.files[0] || !idInput) {
            status.innerText = "âŒ Please select a file and enter a PID/FC.";
            return;
        }

        const pid = idInput.includes("-") ? fcToPid(idInput) : parseInt(idInput);
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const view = new DataView(data.buffer);

                view.setUint32(0x5C, pid, false);

                [0x4C, 0x58].forEach(off => {
                    if (data[off] >= 255) throw new Error(`Overflow at 0x${off.toString(16).toUpperCase()}`);
                    data[off] += 1;
                });

                const crcSlice = data.slice(0x40, 0x7C);
                const leBuffer = new Uint8Array(crcSlice.length);
                for (let i = 0; i < crcSlice.length; i += 4) {
                    leBuffer[i] = crcSlice[i+3];
                    leBuffer[i+1] = crcSlice[i+2];
                    leBuffer[i+2] = crcSlice[i+1];
                    leBuffer[i+3] = crcSlice[i];
                }

                const crcVal = crc32(leBuffer);
                view.setUint32(0x7C, crcVal, false);

                const blob = new Blob([data], { type: "application/octet-stream" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modified_${file.name}`;
                a.click();

                status.className = "text-center text-green-600 font-bold mt-2";
                status.innerText = "âœ… Success! File patched and downloaded.";
            } catch (err) {
                status.className = "text-center text-red-600 font-bold mt-2";
                status.innerText = `âŒ ${err.message}`;
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>